{% extends "index.html" %}
{% block title %} Activity Logger {% endblock %}
{% block content %}

  <body>

    <div class="container">
        <h1>Activity Recorder</h1>
    
        <!-- Participant ID Form -->
        <form class="participant-form" method="POST">
          <label for="participant_id">Participant ID:</label>
          <input type="text" name="participant_id" id="participant_id" value="{{ participant_id }}">
          <button type="submit">Set ID</button>
        </form>
    
        {% if participant_id %}
        <p><strong>Current Participant ID:</strong> {{ participant_id }}</p>
        {% else %}
        <p><em>Please enter a Participant ID above.</em></p>
        {% endif %}
    
        <div class="activity-container">
          <!-- START buttons on the left column -->
          <div class="column">
            {% for task in tasks %}
            <form action="{{ url_for('start_task', task_id=task.id) }}" method="post" class="start-form">
              {% set started = task.id in start_times %}
              {% set stopped = task.id in stop_times %}
              {% if started or stopped %}
                <button type="submit"
                        class="btn disabled start-button"
                        data-task-id="{{ task.id }}"
                        disabled>
                  Start {{ task.id }}
                </button>
              {% else %}
                <button type="submit"
                        class="btn start-enabled start-button"
                        data-task-id="{{ task.id }}">
                  Start {{ task.id }}
                </button>
              {% endif %}
            </form>
            {% endfor %}
          </div>
    
          <!-- STOP buttons on the right column -->
          <div class="column">
            {% for task in tasks %}
            <form action="{{ url_for('stop_task', task_id=task.id) }}" method="post" class="stop-form">
              {% set started = task.id in start_times %}
              {% set stopped = task.id in stop_times %}
              {% if started and not stopped %}
                <button type="submit"
                        class="btn stop-enabled"
                        id="stop-{{ task.id }}">
                  Stop {{ task.id }}
                </button>
              {% else %}
                <button type="submit"
                        class="btn disabled"
                        id="stop-{{ task.id }}"
                        disabled>
                  Stop {{ task.id }}
                </button>
              {% endif %}
            </form>
            {% endfor %}
          </div>
        </div>
      </div>
    
      <script>
        // Attach click event listeners to all start buttons.
        document.querySelectorAll('.start-button').forEach(function(button) {
          button.addEventListener('click', function(e) {
            // Prevent the default form submission to update UI immediately.
            e.preventDefault();
            
            const taskId = this.getAttribute('data-task-id');
    
            // Immediately disable the start button so it cannot be clicked again.
            this.disabled = true;
            this.classList.remove('start-enabled');
            this.classList.add('disabled');
    
            // Update the corresponding stop button: remove disabled styling and enable it.
            const stopButton = document.getElementById('stop-' + taskId);
            if (stopButton) {
              stopButton.disabled = false;
              stopButton.classList.remove('disabled');
              stopButton.classList.add('stop-enabled');  // Now blue
            }
    
            // Now submit the start form via fetch.
            const form = this.closest('form');
            const url = form.getAttribute('action');
    
            fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
              },
              body: ""
            })
            .then(function(response) {
              // Optionally, handle the server response.
              // In this example, we reload the page to synchronize with the server.
              window.location.reload();
            })
            .catch(function(error) {
              console.error('Error:', error);
            });
          });
        });
      </script>
        </body>
{% endblock %}
